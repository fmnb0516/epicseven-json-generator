<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>EPIC SEVEN - JSON GENERATOR</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143765558-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-143765558-2');
    </script>

</head>

<body>

    <div class="navbar navbar-expand-lg fixed-top navbar-dark bg-info">
        <div class="container">
            <a href="./" class="navbar-brand">EPIC SEVEN - JSON GENERATO</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="./datalist.html">データリスト</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./hero.html">英雄データ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./artifact.html">遺物データ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./material.html">特殊素材データ</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="./equipment.html">装備管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./campingcalc.html">キャンプ士気計算</a>
                    </li>
                </ul>

            </div>
        </div>
    </div>

    <div class="container" style="padding-top: 60px;">
        <div class="row">
            <div class="col-lg-12">
                <div class="form-group">
                    <label for="hero-select">英雄選択</label>
                    <input type="text" class="form-control" id="hero-select" autocomplete="on" list="herolist"
                        placeholder="名前を入力...">
                </div>
                <datalist id="herolist">
                </datalist>
            </div>
        </div>
        <div class="row" id="content">
        </div>
    </div>

    <footer class="container">
        <hr />
        <ul style="list-style: none;">
            <li style="display: inline-block;margin-right: 10px;"><a
                    href="https://maphe.github.io/e7-damage-calc/jp/">エピックセブン ダメージ 計算機</a></li>
            <li style="display: inline-block;"><a href="https://game8.jp/epic-seven">エピックセブン攻略Wiki｜ゲームエイト</a></li>
        </ul>
        <p>COPYRIGHT &#169; <a href="https://github.com/fmnb0516/epicseven-json-generator">fmnb0516</a> ALL RIGHTS
            RESERVED. </p>
    </footer>

    <script type="text/x-handlebars" id="template">

        <div class="col-md-6 col-sm-12" data-hero="{{heroData.name}}" id="equipment-container">
            <div style="position: relative;">
                <img class="img-thumbnail" src="{{heroData.thumbnail}}"/>
                <button id="clear-btn" style="position: absolute;top: 20px;left: 10px;" class="btn btn-info">削除</button>
            </div>

            <table class="table table-sm" style="margin-top: 10px;">
                <thead class="thead-dark">
                    <tbody>
                        <tr>
                            <td class="table-dark">名前</td>
                            <td colspan="5"><strong>{{heroData.name}}</strong></td>
                        <tr>
                        <tr>
                            <td class="table-dark">レア</td>
                            <td><span class="badge badge-pill badge-info">{{heroData.rare}}</span></td>
                            <td class="table-dark">クラス</td>
                            <td><span class="badge badge-pill badge-info">{{heroData.clazz}}</span></td>
                            <td class="table-dark">属性</td>
                            <td><span class="badge badge-pill badge-info">{{heroData.type}}</span></td>
                        </tr>
                    </tbody>
                </thead>
            </table>

            <div class="alert alert-dismissible alert-primary">
                <div>
                    <span class="badge badge-dark" style="width: 100px;">攻撃力</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="attack-base">{{calc.attack.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="attack-add">{{calc.attack.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="attack-sum">{{calc.attack.sum}}</span>
                    </div>
                </div>

                <div>
                    <span class="badge badge-dark" style="width: 100px;">生命力</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="health-base">{{calc.health.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="health-add">{{calc.health.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="health-sum">{{calc.health.sum}}</span>
                    </div>
                </div>

                <div>
                    <span class="badge badge-dark" style="width: 100px;">防御力</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="defense-base">{{calc.defense.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="defense-add">{{calc.defense.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="defense-sum">{{calc.defense.sum}}</span>
                    </div>
                </div>

                <div>
                    <span class="badge badge-dark" style="width: 100px;">スピード</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="speed-base">{{calc.speed.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="speed-add">{{calc.speed.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="speed-sum">{{calc.speed.sum}}</span>
                    </div>
                </div>

                <div>
                    <span class="badge badge-dark" style="width: 100px;">クリ率</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="critical_hit-base">{{calc.critical_hit.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="critical_hit-add">{{calc.critical_hit.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="critical_hit-sum">{{calc.critical_hit.sum}}</span>
                    </div>
                </div>

                <div>
                    <span class="badge badge-dark" style="width: 100px;">クリダメ</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="critical_damage-base">{{calc.critical_damage.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="critical_damage-add">{{calc.critical_damage.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="critical_damage-sum">{{calc.critical_damage.sum}}</span>
                    </div>
                </div>

                <div>
                    <span class="badge badge-dark" style="width: 100px;">命中率</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="debuff_hit-base">{{calc.debuff_hit.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="debuff_hit-add">{{calc.debuff_hit.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="debuff_hit-sum">{{calc.debuff_hit.sum}}</span>
                    </div>
                </div>

                <div>
                    <span class="badge badge-dark" style="width: 100px;">抵抗</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="debuff_resist-base">{{calc.debuff_resist.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="debuff_resist-add">{{calc.debuff_resist.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="debuff_resist-sum">{{calc.debuff_resist.sum}}</span>
                    </div>
                </div>

                <div>
                    <span class="badge badge-dark" style="width: 100px;">連携</span>
                    <div style="display: inline-block;padding-left: 20px;">
                        <span class="badge badge-pill badge-success" id="unity-base">{{calc.unity.base}}</span>
                        &nbsp;+&nbsp;
                        <span class="badge badge-pill badge-info" id="unity-add">{{calc.unity.add}}</span>
                        &nbsp;=&nbsp;
                        <span class="badge badge-pill badge-danger" id="unity-sum">{{calc.unity.sum}}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-sm-12">

            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#pos-weapon">武具</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#pos-head">頭具</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#pos-body">胴具</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#pos-reg">脚具</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#pos-neck">首具</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#pos-ring">指輪</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#pos-artifact">遺物</a>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="pos-weapon" style="padding: 20px 5px;">
                    {{equipment-form "weapon" equipmentData.weapon}}
                </div>
                <div class="tab-pane fade" id="pos-head" style="padding: 20px 5px;">
                    {{equipment-form "head" equipmentData.head}}
                </div>
                <div class="tab-pane fade" id="pos-body" style="padding: 20px 5px;">
                    {{equipment-form "body" equipmentData.body}}
                </div>
                <div class="tab-pane fade" id="pos-reg" style="padding: 20px 5px;">
                    {{equipment-form "reg" equipmentData.reg}}
                </div>
                <div class="tab-pane fade" id="pos-neck" style="padding: 20px 5px;">
                    {{equipment-form "neck" equipmentData.neck}}
                </div>
                <div class="tab-pane fade" id="pos-ring" style="padding: 20px 5px;">
                    {{equipment-form "ring" equipmentData.ring}}
                </div>
                <div class="tab-pane fade" id="pos-artifact" style="padding: 20px 5px;">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="form-group">
                                <label for="hero-select">遺物選択</label>
                                <input type="text" class="form-control equipment-input" id="artifact-select" autocomplete="on" list="artifactlist"
                                    placeholder="名前を入力..." value="{{equipmentData.artifact.name}}" data-path="artifact.name" data-type="str" />
                            </div>
                            <datalist id="artifactlist">
                                {{aritfact-options heroData.clazz equipmentData.artifact.name}}
                            </datalist>
                        </div>
                        <div class="col-lg-12">
                            <div class="row">
                                <div class="col-lg-12">
                                    <label>遺物レベル</label>
                                </div>

                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <div class="input-group-prepend">
                                                <button type="button" class="btn btn-info calc-input" data-calc="plus" data-target="artifact-level-input">+</button>
                                            </div>
                                            <input style="text-align: center;" id="artifact-level-input" type="number" class="form-control calc-input equipment-input"
                                                readonly min="0" max="30" value="{{equipmentData.artifact.level}}" data-calc="set" data-target="artifact-level-input-slide"
                                                data-path="artifact.level" data-type="num"/>

                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-info calc-input" data-calc="minus" data-target="artifact-level-input">-</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-8">
                                    <fieldset class="form-group">
                                        <input id="artifact-level-input-slide" type="range" class="custom-range calc-input" min="0" max="30" value="{{equipmentData.artifact.level}}" data-calc="set" data-target="artifact-level-input">
                                    </fieldset>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </script>

    <script type="text/x-handlebars" id="template-equipment-form">
        <div class="row">
            <div class="col-md-2 col-sm-2">
                <span class="badge badge-info">Set</span>
            </div>
            <div class="form-group col-md-10 col-sm-10">
                <select class="form-control form-control-sm equipment-input" id="{{pos}}-set" data-path="{{pos}}.set" data-type="str">
                    {{gen-option-sets equipmentData.set}}
                </select>
            </div>

            <div class="col-md-2 col-sm-2">
                <span class="badge badge-info">main</span>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <select class="form-control form-control-sm equipment-input" id="{{pos}}-main-op" data-path="{{pos}}.main.opt" data-type="str" data-clear-for="{{pos}}-main-val">
                    {{gen-main-option pos equipmentData.main.opt}}
                </select>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <input type="number" class="form-control  form-control-sm equipment-input" id="{{pos}}-main-val" placeholder="..." data-path="{{pos}}.main.val" data-type="num" value="{{equipmentData.main.val}}">
            </div>

            <div class="col-md-2 col-sm-2">
                <span class="badge badge-info">sub1</span>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <select class="form-control form-control-sm equipment-input" id="{{pos}}-sub1-op" data-path="{{pos}}.sub1.opt" data-type="str" data-clear-for="{{pos}}-sub1-val">
                    {{gen-sub-option pos equipmentData.sub1.opt}}
                </select>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <input type="number" class="form-control  form-control-sm equipment-input" id="{{pos}}-sub1-val" placeholder="..." data-path="{{pos}}.sub1.val" data-type="num" value="{{equipmentData.sub1.val}}">
            </div>

            <div class="col-md-2 col-sm-2">
                <span class="badge badge-info">sub2</span>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <select class="form-control form-control-sm equipment-input" id="{{pos}}-sub2-op" data-path="{{pos}}.sub2.opt" data-type="str" data-clear-for="{{pos}}-sub2-val">
                    {{gen-sub-option pos equipmentData.sub2.opt}}
                </select>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <input type="number" class="form-control  form-control-sm equipment-input" id="{{pos}}-sub2-val" placeholder="..." data-path="{{pos}}.sub2.val" data-type="num" value="{{equipmentData.sub2.val}}">
            </div>

            <div class="col-md-2 col-sm-2">
                <span class="badge badge-info">main</span>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <select class="form-control form-control-sm equipment-input" id="{{pos}}-sub3-op" data-path="{{pos}}.sub3.opt" data-type="str" data-clear-for="{{pos}}-sub3-val">
                    {{gen-sub-option pos equipmentData.sub3.opt}}
                </select>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <input type="number" class="form-control form-control-sm equipment-input" id="{{pos}}-sub3-val" placeholder="..." data-path="{{pos}}.sub3.val" data-type="num" value="{{equipmentData.sub3.val}}">
            </div>

            <div class="col-md-2 col-sm-2">
                <span class="badge badge-info">main</span>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <select class="form-control form-control-sm equipment-input" id="{{pos}}-sub4-op" data-path="{{pos}}.sub4.opt" data-type="str" data-clear-for="{{pos}}-sub4-val">
                    {{gen-sub-option pos equipmentData.sub4.opt}}
                </select>
            </div>
            <div class="form-group col-md-5 col-sm-5">
                <input type="number" class="form-control  form-control-sm equipment-input" id="{{pos}}-sub4-val" placeholder="..." data-path="{{pos}}.sub4.val" data-type="num" value="{{equipmentData.sub4.val}}">
            </div>
        </div>

    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.3/handlebars.min.js"
        integrity="sha256-/PJBs6QWvXijOFIX04kZpLb6ZtSQckdOIavLWKKOgXU=" crossorigin="anonymous"></script>

    <script>

        const init = (master) => {

            const updateCalcResult = (calc) => {
                console.log(calc);

                $("#attack-base").text(calc.attack.base);
                $("#attack-add").text(calc.attack.add);
                $("#attack-sum").text(calc.attack.sum);

                $("#health-base").text(calc.health.base);
                $("#health-add").text(calc.health.add);
                $("#health-sum").text(calc.health.sum);

                $("#defense-base").text(calc.defense.base);
                $("#defense-add").text(calc.defense.add);
                $("#defense-sum").text(calc.defense.sum);

                $("#speed-base").text(calc.speed.base);
                $("#speed-add").text(calc.speed.add);
                $("#speed-sum").text(calc.speed.sum);

                $("#critical_hit-base").text(calc.critical_hit.base);
                $("#critical_hit-add").text(calc.critical_hit.add);
                $("#critical_hit-sum").text(calc.critical_hit.sum);

                $("#critical_damage-base").text(calc.critical_damage.base);
                $("#critical_damage-add").text(calc.critical_damage.add);
                $("#critical_damage-sum").text(calc.critical_damage.sum);

                $("#debuff_hit-base").text(calc.debuff_hit.base);
                $("#debuff_hit-add").text(calc.debuff_hit.add);
                $("#debuff_hit-sum").text(calc.debuff_hit.sum);

                $("#debuff_resist-base").text(calc.debuff_resist.base);
                $("#debuff_resist-add").text(calc.debuff_resist.add);
                $("#debuff_resist-sum").text(calc.debuff_resist.sum);

                $("#unity-base").text(calc.unity.base);
                $("#unity-add").text(calc.unity.add);
                $("#unity-sum").text(calc.unity.sum);
            };

            const calculateData = (() => {

                const parcentToFloat = (num) => {
                    return num === 0 ? 0 : num / 100;
                };

                const countSet = (set, req, data) => {
                    const target = [data.weapon.set, data.head.set, data.body.set, data.reg.set, data.neck.set, data.ring.set];
                    return Math.floor(target.filter(k => k === set).length / req);
                };

                const resolveValue = (key, data) => {
                    const target = [
                        data.weapon.main, data.weapon.sub1, data.weapon.sub2, data.weapon.sub3, data.weapon.sub4,
                        data.head.main, data.head.sub1, data.head.sub2, data.head.sub3, data.head.sub4,
                        data.body.main, data.body.sub1, data.body.sub2, data.body.sub3, data.body.sub4,
                        data.reg.main, data.reg.sub1, data.reg.sub2, data.reg.sub3, data.reg.sub4,
                        data.neck.main, data.neck.sub1, data.neck.sub2, data.neck.sub3, data.neck.sub4,
                        data.ring.main, data.ring.sub1, data.ring.sub2, data.ring.sub3, data.ring.sub4,
                    ];

                    const ary = target.filter(d => d.opt === key).map(d => d.val);
                    return ary.length === 0 ? 0 : ary.reduce((prev, current) => prev + current);
                };

                const artifactVal = (key, data) => {
                    const artifact = master.artifact[data.artifact.name];
                    return artifact !== undefined ? artifact.status.max[key] : 0
                };

                return (heroData, equipmentData) => {
                    const result = {
                        attack: {},
                        health: {},
                        defense: {},
                        speed: {},
                        critical_hit: {},
                        critical_damage: {},
                        debuff_hit: {},
                        debuff_resist: {},
                        unity: {},
                    };

                    result.attack.base = heroData.status["max"].attack;
                    result.attack.add = Math.floor(resolveValue("attack-fix", equipmentData)
                        + (result.attack.base * parcentToFloat(resolveValue("attack-percent", equipmentData)))
                        + (countSet("attack-set", 4, equipmentData) * result.attack.base * 0.35)
                        + artifactVal("attack", equipmentData));
                    result.attack.sum = result.attack.base + result.attack.add;

                    result.health.base = heroData.status["max"].health;
                    result.health.add = Math.floor(resolveValue("health-fix", equipmentData)
                        + (result.health.base * parcentToFloat(resolveValue("health-percent", equipmentData)))
                        + (countSet("health-set", 2, equipmentData) * result.health.base * 0.15)
                        + artifactVal("health", equipmentData));
                    result.health.sum = result.health.base + result.health.add;

                    result.defense.base = heroData.status["max"].defense;
                    result.defense.add = Math.floor(resolveValue("defense-fix", equipmentData)
                        + (result.defense.base * parcentToFloat(resolveValue("defense-percent", equipmentData)))
                        + (countSet("defense-set", 2, equipmentData) * result.defense.base * 0.15));
                    result.defense.sum = result.defense.base + result.defense.add;

                    result.speed.base = heroData.status["max"].speed;
                    result.speed.add = Math.floor(resolveValue("speed-fix", equipmentData)
                        + (countSet("speed-set", 4, equipmentData) * result.speed.base * 0.25));
                    result.speed.sum = result.speed.base + result.speed.add;

                    result.critical_hit.base = heroData.status["max"].critical_hit;
                    result.critical_hit.add = resolveValue("crit-hit-percent", equipmentData) + (countSet("critical-set", 2, equipmentData) * 12);
                    result.critical_hit.sum = result.critical_hit.base + result.critical_hit.add;

                    result.critical_damage.base = heroData.status["max"].critical_damage;
                    result.critical_damage.add = resolveValue("crit-damage-percent", equipmentData) + (countSet("ruin-set", 4, equipmentData) * 40);
                    result.critical_damage.sum = result.critical_damage.base + result.critical_damage.add;

                    result.unity.base = heroData.status["max"].unity_chance;
                    result.unity.add = (countSet("unity-set", 2, equipmentData) * 4)
                    result.unity.sum = result.unity.base + result.unity.add;

                    result.debuff_hit.base = heroData.status["max"].debuff_hit;
                    result.debuff_hit.add = resolveValue("effect-percent", equipmentData) + (countSet("effect-set", 2, equipmentData) * 20);
                    result.debuff_hit.sum = result.debuff_hit.base + result.debuff_hit.add;

                    result.debuff_resist.base = heroData.status["max"].debuff_resist;
                    result.debuff_resist.add = resolveValue("resist-percent", equipmentData) + (countSet("resist-set", 2, equipmentData) * 20);
                    result.debuff_resist.sum = result.debuff_hit.base + result.debuff_resist.add;

                    return result;
                };
            })();

            (() => {
                const equipmentSet = [
                    { name: "", label: "-" },
                    { name: "attack-set", label: "攻撃" },
                    { name: "health-set", label: "生命" },
                    { name: "defense-set", label: "防御" },
                    { name: "ruin-set", label: "破滅" },
                    { name: "critical-set", label: "会心" },
                    { name: "speed-set", label: "速度" },
                    { name: "effect-set", label: "命中" },
                    { name: "drain-set", label: "吸収" },
                    { name: "counter-set", label: "反撃" },
                    { name: "resist-set", label: "抵抗" },
                    { name: "rage-set", label: "憤怒" },
                    { name: "immunity-set", label: "免疫" },
                    { name: "unity-set", label: "連携" },
                ];

                const equipmentOpt = [
                    { name: "", label: "-" },
                    { name: "attack-fix", label: "攻撃(固)" },
                    { name: "attack-percent", label: "攻撃(%)" },
                    { name: "health-fix", label: "生命(固)" },
                    { name: "health-percent", label: "生命(%)" },
                    { name: "defense-fix", label: "防御(固)" },
                    { name: "defense-percent", label: "防御(%)" },
                    { name: "speed-fix", label: "速度(固)" },
                    { name: "crit-hit-percent", label: "クリ率(%)" },
                    { name: "crit-damage-percent", label: "クリダメ(%)" },
                    { name: "effect-percent", label: "命中(%)" },
                    { name: "resist-percent", label: "抵抗(%)" },
                ];

                Handlebars.registerHelper('aritfact-options', (clazz) => {

                    const htmls = Object.keys(master.artifact).map(k => master.artifact[k])
                        .map(a => {

                            const disabled = a.target === "全職共用" || a.target === clazz ? "" : "disabled";
                            return "<option " + disabled + " value=\"" + a.name + "\">" + a.name + "</option>";
                        });
                    return new Handlebars.SafeString(htmls.join(""));
                });

                const generateOption = (selected, filter) => {
                    const html = equipmentOpt.filter(filter).map(e => {
                        const selectedText = e.name === selected ? "selected" : "";
                        return "<option " + selectedText + " value=\"" + e.name + "\">" + e.label + "</option>";
                    });
                    return new Handlebars.SafeString(html);
                };

                const formTpl = Handlebars.compile($("#template-equipment-form").html());
                Handlebars.registerHelper('equipment-form', (pos, data) => {
                    return new Handlebars.SafeString(formTpl({ pos: pos, equipmentData: data }));
                });

                Handlebars.registerHelper('gen-option-sets', (val) => {
                    const html = equipmentSet.map(e => {
                        const selected = e.name === val ? "selected" : "";
                        return "<option " + selected + " value=\"" + e.name + "\">" + e.label + "</option>";
                    });
                    return new Handlebars.SafeString(html);
                });

                Handlebars.registerHelper('gen-main-option', (pos, val) => {
                    const mainOpFilter = {
                        weapon: (e) => e.name === "" || e.name === "attack-fix",
                        head: (e) => e.name === "" || e.name === "health-fix",
                        body: (e) => e.name === "" || e.name === "defense-fix",
                        reg: (e) => e.name === "" || ["attack-fix", "attack-percent", "speed-fix", "defense-fix", "defense-percent", "health-fix", "health-percent"].indexOf(e.name) !== -1,
                        neck: (e) => e.name === "" || ["attack-fix", "attack-percent", "defense-fix", "defense-percent", "health-fix", "health-percent", "crit-hit-percent", "crit-damage-percent"].indexOf(e.name) !== -1,
                        ring: (e) => e.name === "" || ["attack-fix", "attack-percent", "defense-fix", "defense-percent", "health-fix", "health-percent", "effect-percent", "resist-percent"].indexOf(e.name) !== -1,
                    };

                    return generateOption(val, mainOpFilter[pos]);
                });

                Handlebars.registerHelper('gen-sub-option', (pos, val) => {
                    const subOpFilter = {
                        weapon: (e) => ["attack-fix", "defense-fix", "defense-percent"].indexOf(e.name) === -1,
                        head: (e) => e.name !== "health-fix",
                        body: (e) => ["attack-fix", "defense-fix", "attack-percent"].indexOf(e.name) === -1,
                        reg: (e) => true,
                        neck: (e) => true,
                        ring: (e) => true,
                    };
                    return generateOption(val, subOpFilter[pos]);
                });
            })();

            const template = Handlebars.compile($("#template").html());

            const storage = (() => {
                const inital = JSON.stringify({
                    set: "",
                    main: { opt: "", val: "" },
                    sub1: { opt: "", val: "" },
                    sub2: { opt: "", val: "" },
                    sub3: { opt: "", val: "" },
                    sub4: { opt: "", val: "" },
                });

                const current = () => {
                    return $("#equipment-container").attr("data-hero");
                };

                const attribute = (id, path, val) => {
                    const paths = path.split(".");
                    const key = paths.pop();

                    const data = get(id);
                    let search = data;

                    paths.forEach(e => search = search[e]);
                    search[key] = val;
                    put(id, data);
                };

                const put = (id, data) => {
                    if (data === null || data === undefined) {
                        localStorage.removeItem(id);
                    } else {
                        localStorage.setItem(id, JSON.stringify(data));
                    }
                };

                const get = (id) => {
                    const data = localStorage.getItem(id);
                    return data !== undefined && data !== null ? JSON.parse(data) : {
                        weapon: JSON.parse(inital),
                        head: JSON.parse(inital),
                        body: JSON.parse(inital),
                        reg: JSON.parse(inital),
                        neck: JSON.parse(inital),
                        ring: JSON.parse(inital),
                        artifact: { name: "", level: 0 },
                    };
                };

                return { get: get, put: put, current: current, attribute: attribute };
            })();

            const loadPage = (id) => {
                if (id === "") {
                    $("#content").html("");
                    return;
                }

                $("#artifact-select").val("");
                const heroData = master.hero[id];
                const equipmentData = storage.get(id);

                $("#content").html(template({
                    heroData: heroData,
                    equipmentData: equipmentData,
                    calc: calculateData(heroData, equipmentData)
                }));
            };

            const id = decodeURI((location.hash.startsWith("#") ? location.hash.substring(1) : location.hash).trim());
            $("#hero-select").val(id);

            $("#hero-select").change((e) => {
                location.hash = $(e.target).val();
                $("#hero-select").blur();
            });

            $("body").on("change", ".equipment-input", (e) => {
                const selector = $(e.target);

                const path = selector.attr("data-path");
                const type = selector.attr("data-type");
                const val = selector.val();

                const id = storage.current();

                storage.attribute(id, path, type === "num" ? parseInt(val) : val);

                const clear = selector.attr("data-clear-for");
                if (val === "" && clear !== "") {
                    $("#" + clear).val("").change();
                }

                calc = calculateData(master.hero[id], storage.get(id));
                updateCalcResult(calc);
            });

            $("body").on("click", ".calc-input", (e) => {
                const selector = $(e.target);
                const type = selector.attr("data-calc");
                const target = $("#" + (selector.attr("data-target")));

                const min = parseInt(target.attr("min"));
                const max = parseInt(target.attr("max"));
                const val = parseInt(target.val());

                if (type === "plus" && (val + 1) <= max) {
                    target.val((val + 1)).change();
                } else if (type === "minus" && (val - 1) >= min) {
                    target.val((val - 1)).change();
                }
            });

            $("body").on("change", ".calc-input", (e) => {
                const selector = $(e.target);
                const type = selector.attr("data-calc");
                const target = $("#" + (selector.attr("data-target")));

                if (selector.val() === target.val() || type !== "set") {
                    return;
                }
                target.val(selector.val()).change();
            });

            $("body").on("click", "#clear-btn", (e) => {
                storage.put(storage.current());
                $("#hero-select").val("").change();
            });


            window.addEventListener('hashchange', () => {
                const id = decodeURI((location.hash.startsWith("#") ? location.hash.substring(1) : location.hash).trim());
                loadPage(id);
            });

            loadPage(id);
        };

        $(() => {
            const master = {
                hero: {},
                artifact: {}
            };

            const f1 = fetch('./hero/heros.json')
                .then((response) => response.text())
                .then(text => JSON.parse(text))
                .then(json => {
                    const futures = json.map((e) => {
                        $("#herolist").append($("<option>").attr("value", e.substring(0, e.length - 5)).text(e.substring(0, e.length - 5)));
                        return fetch("./hero/" + e).then(r => r.text())
                            .then(j => JSON.parse(j))
                            .then(j => master.hero[j.name] = j);
                    });

                    return Promise.all(futures);
                });
            const f2 = fetch('./artifact/artifacts.json')
                .then((response) => response.text())
                .then(text => JSON.parse(text))
                .then(json => {
                    const futures = json.map((e) => {
                        return fetch("./artifact/" + e).then(r => r.text())
                            .then(j => JSON.parse(j))
                            .then(j => master.artifact[j.name] = j);
                    });
                    return Promise.all(futures);
                });

            Promise.all([f1, f2]).then(() => {
                init(master);
            });
        });

    </script>
</body>

</html>